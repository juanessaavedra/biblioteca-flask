name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Instalar Docker Compose (si no estÃ¡ presente)
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose
    
    - name: Construir y levantar servicios
      run: docker-compose up --build -d
    
    - name: Ejecutar pruebas unitarias
      run: docker-compose exec -T app pytest tests/unit/ -v
    
    - name: Ejecutar pruebas de integraciÃ³n
      run: docker-compose exec -T app pytest tests/integration/ -v

    - name: Ejecutar pruebas de UI
      run: docker-compose exec -T app pytest tests/ui/ -v

    - name: Ejecutar pruebas de seguridad
      run: docker-compose exec -T app pytest tests/security/ -v

    - name: Ejecutar pruebas de rendimiento
      run: docker-compose exec -T app pytest tests/rendimiento/ -v

    - name: Ejecutar pruebas de carga y estrÃ©s
      run: docker-compose exec -T app locust -f tests/carga-estres/locustfile.py --headless -u 10 -r 2 -t 1m

    - name: Verificar endpoints principales
      run: |
        curl -f http://localhost:5000/health
        curl -f http://localhost:5000/usuarios
        curl -f http://localhost:5000/libros
    
    - name: Limpiar
      run: docker-compose down

  deploy:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Mensaje de Listo para Desplegar
      run: echo "ðŸŽ‰ Listo para desplegar ðŸŽ‰"
